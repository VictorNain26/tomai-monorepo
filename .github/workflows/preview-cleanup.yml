# Cleanup preview environments when PR is closed/merged
name: Preview Cleanup

on:
  pull_request:
    branches: [main]
    types: [closed]

jobs:
  cleanup:
    name: Cleanup Preview
    runs-on: ubuntu-latest
    steps:
      - name: Install Koyeb CLI
        uses: koyeb-community/koyeb-actions@v2
        with:
          api_token: ${{ secrets.KOYEB_API_TOKEN }}

      - name: Delete preview app
        uses: koyeb/action-git-deploy/cleanup@v1
        with:
          app-name: tomai-preview-${{ github.event.pull_request.number }}

      - name: Comment PR cleanup
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '## ðŸ§¹ Preview Cleaned Up\n\nThe preview environment has been deleted.'
            });
